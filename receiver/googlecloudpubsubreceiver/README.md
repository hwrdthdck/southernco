# Google Pubsub Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [beta]: traces, logs, metrics   |
| Distributions | [] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fgooglecloudpubsub%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fgooglecloudpubsub) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fgooglecloudpubsub%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fgooglecloudpubsub) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@alexvanboxel](https://www.github.com/alexvanboxel) |

[beta]: https://github.com/open-telemetry/opentelemetry-collector#beta
<!-- end autogenerated section -->

> ⚠️ This is a community-provided module. It has been developed and extensively tested at Collibra, but it is not officially supported by GCP.
 
This receiver gets OTLP messages from a Google Cloud [Pubsub](https://cloud.google.com/pubsub) subscription.

The following configuration options are supported:

* `project` (Optional): The Google Cloud Project of the client connects to.
* `subscription` (Required): The subscription name to receive OTLP data from. The subscription name  should be a 
  fully qualified resource name (eg: `projects/otel-project/subscriptions/otlp`).
* `encoding` (Optional): The encoding that will be used to received data from the subscription. This can either be
  `otlp_proto_trace`, `otlp_proto_metric`, `otlp_proto_log`, `cloud_logging`, or `raw_text` (see `encoding`).  This will
  only be used as a fallback, when no `content-type` attribute is present.
* `compression` (Optional): The compression that will be used on received data from the subscription. When set it can 
  only be `gzip`. This will only be used as a fallback, when no `content-encoding` attribute is present.
* `endpoint` (Optional): Override the default Pubsub Endpoint, useful when connecting to the PubSub emulator instance
  or switching between [global and regional service endpoints](https://cloud.google.com/pubsub/docs/reference/service_apis_overview#service_endpoints).
* `insecure` (Optional): allows performing “insecure” SSL connections and transfers, useful when connecting to a local
   emulator instance. Only has effect if Endpoint is not ""

```yaml
receivers:
  googlecloudpubsub:
    project: otel-project
    subscription: projects/otel-project/subscriptions/otlp-logs
    encoding: raw_json
```

## Encoding

You should not need to set the encoding of the subscription as the receiver will try to discover the type of the data
by looking at the `ce-type` and `content-type` attributes of the message. Only when those attributes are not set 
must the `encoding` field in the configuration be set. 

| ce-type                           | ce-datacontenttype   | encoding          | description                                    |
|-----------------------------------|----------------------|-------------------|------------------------------------------------|
| org.opentelemetry.otlp.traces.v1  | application/protobuf |                   | Decode OTLP trace message                      |
| org.opentelemetry.otlp.metrics.v1 | application/protobuf |                   | Decode OTLP metric message                     |
| org.opentelemetry.otlp.logs.v1    | application/protobuf |                   | Decode OTLP log message                        |
| -                                 | -                    | otlp_proto_trace  | Decode OTLP trace message                      |
| -                                 | -                    | otlp_proto_metric | Decode OTLP metric message                     |
| -                                 | -                    | otlp_proto_log    | Decode OTLP log message                        |
| -                                 | -                    | cloud_logging     | Decode [Cloud Logging] [LogEntry] message type |
| -                                 | -                    | raw_text          | Wrap in an OTLP log message                    |

When the `encoding` configuration is set, the attributes on the message are ignored.

With `cloud_logging`, the receiver can be used to bring Cloud Logging messages into an OpenTelemetry pipeline. You'll
first need to [set up a logging sink][sink-docs] with a Pub/Sub topic as its destination. Note that the `cloud_logging`
integration is considered **alpha** as the semantic convention on some of the conversion are not stabilized yet.

With `raw_text`, the receiver can be used for ingesting arbitrary text message on a Pubsub subscription, wrapping them
in OTLP Log messages, making it a convenient way to ingest raw log lines from Pubsub.

[Cloud Logging]: https://cloud.google.com/logging
[LogEntry]: https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry
[sink-docs]: https://cloud.google.com/logging/docs/export/configure_export_v2#creating_sink

## Pubsub subscription

The Google Cloud [Pubsub](https://cloud.google.com/pubsub) receiver doesn't automatically create subscriptions, 
it expects the subscription to be created upfront. Security wise it's best to give the collector its own 
service account and give the subscription `Pub/Sub Subscriber` permission.

The subscription should also be of delivery type `Pull`.

### Filtering

When the messages on the subscription are accompanied by the correct attributes and you only need a specific
type in your pipeline, the messages can be [filtered](https://cloud.google.com/pubsub/docs/filtering) on the 
subscription saving on egress fees.

An example of filtering on trace message only: 
```
attributes.ce-type = "org.opentelemetry.otlp.traces.v1"
AND
attributes.content-type = "application/protobuf"
```

# Google Cloud Logging

**Status**: Experimental

Google Cloud logging uses the [LogEntry] to carry log information. In this section, the mapping of the fields to 
OpenTelemetry fields and attributes are documented.

## Semantic Mapping

Some of the attributes can be moved to OpenTelemetry Semantic Conventions. Note, however, that all the attributes are
considered experimental and are subject to change.

| Field       | Type      | Description                            | Maps to Unified Model Field    |
|-------------|-----------|----------------------------------------|--------------------------------|
| `insert_id` | `boolean` | A unique identifier for the log entry. | `Attributes["log.record.uid"]` |

## Attribute and Field mapping

The rest of the JSON body is either mapped to attributes with a `gcp` prefix or directly mapped to the LogRecord. 

| Field              | Type                     | Description                                                                                                      | Maps to Unified Model Field                   |
|--------------------|--------------------------|------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
| `timestamp`        | `string`                 | The time the event described by the log entry occurred.                                                          | `Timestamp`                                   |
| `receiveTimestamp` | `string`                 | The time the log entry was received.                                                                             | `ObservedTimestamp`                           |
| `logName`          | `string`                 | The URL-encoded log ID suffix of the log_name field identifies which log stream this entry belongs to.           | `Attributes["gcp.log_name"]` (string)         |
| `jsonPayload`      | `google.protobuf.Struct` | The log entry payload, represented as a structure that is expressed as a JSON object.                            | `Body` (KVList)                               |
| `protoPayload`     | `google.protobuf.Any`    | The log entry payload, represented as a protocol buffer.                                                         | `Body` (KVList, key from JSON representation) |
| `textPayload`      | `string`                 | The log entry payload, represented as a Unicode string (UTF-8).                                                  | `Body` (string)                               |
| `trace`            | `string`                 | The trace associated with the log entry, if any.                                                                 | `TraceId`                                     |
| `spanId`           | `string`                 | The span ID within the trace associated with the log entry.                                                      | `SpanId`                                      |
| `traceSampled`     | `boolean`                | The sampling decision of the trace associated with the log entry.                                                | `TraceFlags.SAMPLED`                          |
| `labels`           | `map<string,string>`     | A set of user-defined (key, value) data that provides additional information about the log entry.                | `Attributes["gcp.*"]`                         |
| `resource`         | `MonitoredResource`      | The monitored resource that produced this log entry.                                                             | `Resource["gcp.*"]`                           |
| `httpRequest`      | `HttpRequest`            | The HTTP request associated with the log entry, if any.                                                          | `Attributes["gcp.http_request"]` (KVList)     |
| `operation`        | `LogEntryOperation`      | Information about a operation associated with the log entry.                                                     | `Attributes["gcp.operation"]`  (KVList)       |
| `sourceLocation`   | `LogEntrySourceLocation` | Source code location information associated with the log entry.                                                  | `Attributes["gcp.source_location"]` (KVList)  |
| `split`            | `LogSplit`               | Information indicating this LogEntry is part of a sequence of multiple log entries split from a single LogEntry. | `Attributes["gcp.log_split"]`  (KVList)       |

## Severity Mapping

The severity is mapping from [Google Cloud Log Severity](https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry#LogSeverity) to the OpenTelemetry Severity Number.

| CloudLog         | Severity Number  | CloudLog Description                                                                   |
|------------------|------------------|----------------------------------------------------------------------------------------|
| `DEFAULT`(0)     | `UNSPECIFIED`(0) | The log entry has no assigned severity level.                                          |
| `DEBUG`(100)     | `DEBUG`(5)       | Debug or trace information.                                                            |
| `INFO`(200)      | `INFO`(9)        | Routine information, such as ongoing status or performance.                            |
| `NOTICE`(300)    | `INFO2`(10)      | Normal but significant events, such as start up, shut down, or a configuration change. |
| `WARNING`(400)   | `WARN`(13)       | Warning events might cause problems.                                                   |
| `ERROR`(500)     | `ERROR`(17)      | Error events are likely to cause problems.                                             |
| `CRITICAL`(600)  | `FATAL`(21)      | Critical events cause more severe problems or outages.                                 |
| `ALERT`(700)     | `FATAL2`(22)     | A person must take an action immediately.                                              |
| `EMERGENCY`(800) | `FATAL4`(24)     | One or more systems are unusable.                                                      |
